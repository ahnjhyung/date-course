<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ë‚­ë§Œì˜ ë°¤: ë°ì´íŠ¸ ì½”ìŠ¤ ë©”ì´ì»¤</title>
    <style>
        body { font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
        
        /* ì™¼ìª½ ì‚¬ì´ë“œë°” ë””ìì¸ */
        #menu_wrap { width: 360px; display: flex; flex-direction: column; background: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 10; }
        .search-box { padding: 15px; background: #3396ff; color: #fff; }
        .search-box h3 { margin: 0 0 10px 0; font-size: 18px; }
        .search-box input { width: 70%; padding: 8px; border: none; border-radius: 4px; }
        .search-box button { width: 25%; padding: 8px; border: none; background: #1352a2; color: #fff; border-radius: 4px; cursor: pointer; }
        
        /* ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */
        #placesList { flex: 1; overflow-y: auto; padding: 0; margin: 0; background: #f9f9f9; border-bottom: 1px solid #ddd; }
        .place-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .place-item:hover { background: #e6f7ff; }
        .place-name { font-weight: bold; font-size: 16px; color: #333; }
        .place-addr { font-size: 13px; color: #888; margin-top: 5px; }

        /* ë‚´ ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ (ì•„ë˜ìª½) */
        .course-box { height: 35%; display: flex; flex-direction: column; border-top: 2px solid #333; background: #fff; }
        .course-header { padding: 10px; background: #333; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .course-header h3 { margin: 0; font-size: 16px; }
        #myCourseList { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .course-item { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .course-number { background: #3396ff; color: #fff; width: 20px; height: 20px; border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px; margin-right: 10px; }
        
        /* ë²„íŠ¼ */
        .btn-optimize { width: 100%; padding: 15px; background: #ff5f4a; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-optimize:hover { background: #e04a36; }

        /* ì§€ë„ ì˜ì—­ */
        #map { flex-grow: 1; }
    </style>
</head>
<body>

    <div id="menu_wrap">
        <div class="search-box">
            <h3>ì¥ì†Œ ê²€ìƒ‰</h3>
            <form onsubmit="searchPlaces(); return false;">
                <input type="text" id="keyword" placeholder="ì˜ˆ: ê°•ë‚¨ ë§›ì§‘, ë¡¯ë°ì›”ë“œ">
                <button type="submit">ê²€ìƒ‰</button>
            </form>
        </div>

        <div id="placesList">
            <div style="padding:20px; text-align:center; color:#999;">í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•˜ê³ <br>ì¥ì†Œë¥¼ í´ë¦­í•´ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>
        </div>
        
        <div class="course-box">
            <div class="course-header">
                <h3>ë‚´ ì—¬í–‰ ì½”ìŠ¤</h3>
                <span id="totalDist" style="font-size:12px; color:#ddd;">0km</span>
            </div>
            <ul id="myCourseList"></ul>
            <button class="btn-optimize" onclick="optimizeCourse()">ğŸ”„ ë™ì„  ìµœì í™” (ê±°ë¦¬ìˆœ ì •ë ¬)</button>
        </div>
    </div>

    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4008a66a7ff5dc511df12d63cfeac1f6&libraries=services"></script>
    
    <script>
        // 1. ì§€ë„ ìƒì„±
        var mapContainer = document.getElementById('map'), 
            mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567), 
                level: 3 
            };  
        var map = new kakao.maps.Map(mapContainer, mapOption); 
        
        // 2. ì£¼ìš” ë³€ìˆ˜
        var ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´
        var myCourse = []; // ì„ íƒí•œ ì¥ì†Œ ë°ì´í„° ì €ì¥
        var markers = [];  // ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ë“¤
        var polyline = null; // ê²½ë¡œ ì„ 

        // 3. í‚¤ì›Œë“œ ê²€ìƒ‰ í•¨ìˆ˜
        function searchPlaces() {
            var keyword = document.getElementById('keyword').value;
            if (!keyword.trim()) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            ps.keywordSearch(keyword, placesSearchCB); 
        }

        // 4. ê²€ìƒ‰ ê²°ê³¼ ì½œë°±
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                displayPlaces(data);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            } else if (status === kakao.maps.services.Status.ERROR) {
                alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // 5. ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displayPlaces(places) {
            var listEl = document.getElementById('placesList');
            listEl.innerHTML = ''; 

            for (var i=0; i<places.length; i++) {
                var itemEl = document.createElement('div');
                itemEl.className = 'place-item';
                itemEl.innerHTML = '<div class="place-name">' + places[i].place_name + '</div>' +
                                   '<div class="place-addr">' + places[i].road_address_name + '</div>';
                
                // í´ë¦­ ì´ë²¤íŠ¸ (í´ë¡œì €)
                (function(place) {
                    itemEl.onclick = function() {
                        addToCourse(place);
                    };
                })(places[i]);

                listEl.appendChild(itemEl);
            }
        }

        // 6. ì½”ìŠ¤ ì¶”ê°€ ë° ì§€ë„ ê·¸ë¦¬ê¸°
        function addToCourse(place) {
            // ì¤‘ë³µ ì²´í¬
            for(var i=0; i<myCourse.length; i++) {
                if(myCourse[i].id === place.id) {
                    alert("ì´ë¯¸ ì½”ìŠ¤ì— ìˆëŠ” ì¥ì†Œì…ë‹ˆë‹¤.");
                    return;
                }
            }

            // ë°ì´í„° ì¶”ê°€
            myCourse.push(place);
            renderCourse(); // í™”ë©´ ê°±ì‹ 
        }

        // 7. í™”ë©´ ë° ì§€ë„ ê°±ì‹  (í•µì‹¬ ë¡œì§)
        function renderCourse() {
            var listEl = document.getElementById('myCourseList');
            listEl.innerHTML = '';
            
            // ê¸°ì¡´ ë§ˆì»¤ ë° ì„  ì œê±°
            removeMapElements();

            var linePath = [];
            var bounds = new kakao.maps.LatLngBounds(); // ì§€ë„ ë²”ìœ„ ì¬ì„¤ì •ìš©

            for(var i=0; i<myCourse.length; i++) {
                var place = myCourse[i];
                var position = new kakao.maps.LatLng(place.y, place.x);
                
                // 1) ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                var li = document.createElement('li');
                li.className = 'course-item';
                li.innerHTML = '<span class="course-number">' + (i+1) + '</span>' + 
                               '<span>' + place.place_name + '</span>';
                listEl.appendChild(li);

                // 2) ì§€ë„ì— ë§ˆì»¤ ì¶”ê°€
                var marker = new kakao.maps.Marker({
                    position: position,
                    map: map,
                    title: place.place_name
                });
                markers.push(marker);

                // 3) ì„  ê·¸ë¦¬ê¸°ìš© ê²½ë¡œ ì €ì¥
                linePath.push(position);
                bounds.extend(position);
            }

            // 4) ê²½ë¡œ ì„  ê·¸ë¦¬ê¸°
            if(linePath.length > 1) {
                polyline = new kakao.maps.Polyline({
                    path: linePath, 
                    strokeWeight: 5, 
                    strokeColor: '#ff5f4a', 
                    strokeOpacity: 0.8, 
                    strokeStyle: 'solid' 
                });
                polyline.setMap(map);
                
                // ê±°ë¦¬ ê³„ì‚°í•´ì„œ í‘œì‹œ
                var distance = Math.round(polyline.getLength());
                document.getElementById('totalDist').innerText = "ì´ ê±°ë¦¬: " + (distance/1000).toFixed(1) + "km";
            }

            // 5) ì§€ë„ ë²”ìœ„ ìë™ ì¡°ì •
            if(myCourse.length > 0) {
                map.setBounds(bounds);
            }
        }

        // ì§€ë„ ìœ„ ìš”ì†Œë“¤ ì§€ìš°ê¸°
        function removeMapElements() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
            if (polyline) {
                polyline.setMap(null);
                polyline = null;
            }
        }

        // 8. [ì•Œê³ ë¦¬ì¦˜] ë™ì„  ìµœì í™” (íƒìš• ì•Œê³ ë¦¬ì¦˜: ê°€ê¹Œìš´ ê³³ë¶€í„° ê°€ê¸°)
        function optimizeCourse() {
            if(myCourse.length < 3) {
                alert("ìµœì†Œ 3ê°œ ì´ìƒì˜ ì¥ì†Œê°€ ìˆì–´ì•¼ ìµœì í™”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            var startNode = myCourse[0]; // ì²« ë²ˆì§¸ ì¥ì†ŒëŠ” 'ìˆ™ì†Œ'ë‚˜ 'ì¶œë°œì§€'ë¡œ ê³ ì •
            var optimized = [startNode];
            var remaining = myCourse.slice(1); // ë‚˜ë¨¸ì§€ë§Œ ì •ë ¬ ëŒ€ìƒ

            while(remaining.length > 0) {
                var current = optimized[optimized.length - 1];
                var nearestIdx = -1;
                var minDist = Infinity;

                // ê°€ì¥ ê°€ê¹Œìš´ ë‹¤ìŒ ì¥ì†Œ ì°¾ê¸°
                for(var i=0; i<remaining.length; i++) {
                    var dist = getDistance(current.y, current.x, remaining[i].y, remaining[i].x);
                    if(dist < minDist) {
                        minDist = dist;
                        nearestIdx = i;
                    }
                }

                // ì°¾ì€ ì¥ì†Œë¥¼ í™•ì • ëª©ë¡ìœ¼ë¡œ ì´ë™
                optimized.push(remaining[nearestIdx]);
                remaining.splice(nearestIdx, 1);
            }

            myCourse = optimized; // ìˆœì„œ ë®ì–´ì“°ê¸°
            renderCourse(); // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            alert("ë™ì„ ì´ ê±°ë¦¬ìˆœìœ¼ë¡œ ì¬ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // ì§ì„  ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (í”¼íƒ€ê³ ë¼ìŠ¤ ê·¼ì‚¬ì¹˜, ì‹¤ì œ ë„ë¡œ ì•„ë‹˜)
        function getDistance(lat1, lon1, lat2, lon2) {
            return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lon1 - lon2, 2));
        }

    </script>
</body>
</html>